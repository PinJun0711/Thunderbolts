service: thunderbolts-orders

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-southeast-5
  stage: ${opt:stage, 'prod'}
  environment:
    NODE_ENV: production
    MONGODB_URI: mongodb+srv://pinjun040711:Dxda6769@cluster0.pq1ueqp.mongodb.net/thunderbolts_orders?retryWrites=true&w=majority
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - sagemaker:CreateTrainingJob
            - sagemaker:DescribeTrainingJob
            - sagemaker:StopTrainingJob
            - sagemaker:ListTrainingJobs
            - sagemaker:InvokeEndpoint
          Resource: "*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

functions:
  # Main API function
  api:
    handler: server.js
    events:
      - http:
          path: /{proxy+}
          method: any
          cors: true
      - http:
          path: /
          method: any
          cors: true

  # SageMaker direct integration
  sagemakerDirect:
    handler: handlers/sagemaker-direct.handler
    events:
      - http:
          path: /api/sagemaker/train
          method: post
          cors: true
      - http:
          path: /api/sagemaker/predict
          method: get
          cors: true

  # Scheduled training (runs daily)
  scheduledTraining:
    handler: handlers/sagemaker-direct.handler
    events:
      - schedule: rate(1 day)

  Outputs:
    ApiUrl:
      Description: "API Gateway endpoint URL"
      Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}/"
